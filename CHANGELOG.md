# 更新日志 (Changelog)

所有项目的重要变更都会在此文件中记录。

本项目遵循 [语义化版本](https://semver.org/lang/zh-CN/) 规范。

---

## [1.0.3] - 2026-01-27

### 新增
- **日志导出功能改进** - 当使用 `.log end` 命令结束日志会话时，机器人现在会自动将日志文件发送到聊天窗口供用户下载
  - 日志以JSON格式导出，包含时间戳、用户名、消息内容和图片链接
  - 支持被动消息（反馈式消息）的标准API调用

### 改进
- **日志系统优化**
  - 优化 `export_session()` 方法，提高文件生成的可靠性
  - 改进错误处理，提供更详细的错误信息反馈
  - 添加文件导出失败和发送失败的错误提示

### 修复
- **修复异步处理问题** 
  - 修复 `cmd_log_end()` 中 `MessageEventResult` 不能用 `await` 的错误
  - 改进 `end_session()` 方法的返回值设计，不再混合数据和消息发送逻辑
  - 改进 `export_session()` 方法的返回值，改为返回 `(bool, str)` 表示成功状态和结果

### 架构改进
- **职责分离** - 重新设计日志导出流程
  - `log.py` 的方法现在专注于数据操作，不处理消息发送
  - `main.py` 的 `cmd_log_end()` 独立处理消息发送逻辑
  - 避免了异步操作的混乱，提高代码可维护性

### 配置
- 新增输出配置项：
  - `log.export_failed` - 日志导出失败提示
  - `log.send_file_failed` - 文件发送失败提示

### 技术细节
- 使用 `astrbot.api.message_components.File` 发送日志文件
- 实现异步文件处理流程，确保不阻塞聊天消息
- 文件命名格式：`{群ID}_{日志名}.json`
- 改进的异步流程：`end_session()` → `export_session()` → 文件发送

---

## [1.0.2] - 2026-01-XX

### 新增
- 日志记录功能框架搭建
- 支持创建、暂停、恢复和结束日志会话
- 支持查看活跃日志列表和删除日志记录

### 功能
- `.log new [日志名]` - 创建新的日志会话
- `.log on [日志名]` - 恢复已暂停的日志会话
- `.log off` - 暂停当前日志记录
- `.log end` - 结束日志会话（现已支持直接发送文件到聊天窗口）
- `.log list` - 查看所有日志会话
- `.log del <日志名>` - 删除指定日志
- `.log get <日志名>` - 导出指定日志

---

## [1.0.1] - 2026-01-XX

### 改进
- 完善人物卡系统的属性管理
- 优化骰子掷出结果的显示格式
- 改进技能检定的逻辑流程

---

## [1.0.0] - 2026-01-XX

### 初始发布
- 基础掷骰功能（支持D&D、CoC等标准规则）
- 人物卡管理系统
- 技能检定与对抗检定
- 自定义别名支持
- COC理智检定（带疯狂判定）
- 吸血鬼规则掷骰
- 自定义输出风格（通过config.yaml）
- 基础日志记录框架

---

## 使用说明

### 日志导出流程
1. 使用 `.log new` 创建新日志会话
2. 在会话中进行各种操作（掷骰、技能检定等），机器人会自动记录
3. 使用 `.log end` 结束日志，机器人会自动：
   - 关闭日志会话
   - 将记录的所有内容导出为JSON文件
   - **发送文件到聊天窗口**供用户下载

### 日志文件格式
```json
{
  "version": 1,
  "items": [
    {
      "nickname": "用户昵称",
      "IMUserId": "用户ID",
      "time": "2026/01/27 15:30:45",
      "message": "消息内容",
      "images": ["图片URL列表"],
      "isDice": false
    }
  ]
}
```

---

## 项目信息

- **项目名称**: 星星骰娘-重骰版
- **当前版本**: v1.0.3
- **作者**: 星空凌
- **基础项目**: [Astrbot_plugin_TRPGdice-Complete](https://github.com/WhiteEurya/Astrbot_plugin_TRPGdice-Complete)
- **仓库**: https://github.com/WhiteEurya/Astrbot_plugin_TRPGdice-Rerolled

---

## 贡献

欢迎提交问题报告(Issue)和改进建议(Pull Request)！
